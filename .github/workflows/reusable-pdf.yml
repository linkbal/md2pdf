name: Reusable PDF Generator

on:
  workflow_call:
    inputs:
      input_dir:
        description: 'Markdownファイルがあるディレクトリ'
        required: false
        default: 'docs'
        type: string
      output_dir:
        description: 'PDFを出力するディレクトリ'
        required: false
        default: 'output'
        type: string
      artifact_name:
        description: 'アーティファクト名'
        required: false
        default: 'pdf-output'
        type: string
      retention_days:
        description: 'アーティファクトの保持日数'
        required: false
        default: 30
        type: number
      create_release:
        description: 'GitHub Releaseを作成するか'
        required: false
        default: false
        type: boolean
      keep_releases:
        description: '保持するリリース数（create_release=true時のみ有効）'
        required: false
        default: 5
        type: number

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 呼び出し元リポジトリをチェックアウト
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: md2pdfリポジトリをチェックアウト
        uses: actions/checkout@v4
        with:
          repository: linkbal/md2pdf
          path: .md2pdf-tools

      - name: Dockerイメージをビルド
        run: |
          docker build -t md2pdf .md2pdf-tools/scripts

      - name: PDFを生成
        run: |
          mkdir -p ${{ inputs.output_dir }}
          docker run --rm \
            -v ${{ github.workspace }}/${{ inputs.input_dir }}:/work/input:ro \
            -v ${{ github.workspace }}/${{ inputs.output_dir }}:/work/output \
            md2pdf /work/input /work/output

      - name: 生成されたPDFを確認
        run: |
          echo "Generated PDFs:"
          ls -la ${{ inputs.output_dir }}/

      - name: PDFをアーティファクトとしてアップロード
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: ${{ inputs.output_dir }}/**/*.pdf
          retention-days: ${{ inputs.retention_days }}

      - name: タグを作成
        if: inputs.create_release
        id: create_tag
        run: |
          TAG_NAME="v$(date +'%Y%m%d')-${GITHUB_SHA::7}"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          git tag $TAG_NAME
          git push origin $TAG_NAME

      - name: リリースを作成
        if: inputs.create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.create_tag.outputs.tag_name }}
          name: Release ${{ steps.create_tag.outputs.tag_name }}
          files: ${{ inputs.output_dir }}/**/*.pdf
          generate_release_notes: true

      - name: 古いリリースを削除
        if: inputs.create_release
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: ${{ inputs.keep_releases }}
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: クリーンアップ
        if: always()
        run: |
          rm -rf .md2pdf-tools
